<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - GP Kitchen</title>
    <link rel="icon" type="image/png" href="https://static.runelite.net/cache/item/icon/995.png">
    <link rel="stylesheet" href="/css/app.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-left">
            <a href="/" class="nav-brand">GP Kitchen</a>
            <a href="/presets">Presets</a>
        </div>
        <div class="nav-right">
            % if (is_authenticated) {
                % if (is_admin && is_dev_mode) {
                    <form method="post" action="/admin/update-prices" style="display:inline">
                        <input type="hidden" name="csrf_token" value="<%= csrf_token %>">
                        <button type="submit" class="btn btn-small">Update Prices</button>
                    </form>
                % }
                % if (is_guest) {
                    <a href="/register" class="btn btn-small btn-primary">Save Account</a>
                % } else {
                    <span class="nav-user"><%= current_user->{username} %></span>
                % }
                <a href="/logout">Logout</a>
            % } else {
                <a href="/login">Login</a>
            % }
        </div>
    </nav>

    % if (is_guest && current_user) {
        <div class="guest-banner">
            You're using a guest account. <a href="/register">Save your account</a> to not lose your dashboard.
        </div>
    % }

    <main class="container">
        <%= content %>
    </main>

    <footer class="footer">
        <p>
            % if (stash('stats') && stash('stats')->{total_items}) {
                <%= stash('stats')->{total_items} %> items |
                <%= stash('stats')->{items_with_high} // 0 %> with prices |
            % }
            Price data from <a href="https://prices.runescape.wiki" target="_blank">OSRS Wiki</a> |
            Last update: <%= time_ago(stash('stats') ? stash('stats')->{last_update} : undef) %>
        </p>
    </footer>

    % if (flash 'restore_scroll') {
    <script>
        (function() {
            var y = localStorage.getItem('scrollY');
            if (y) window.scrollTo(0, parseInt(y, 10));
        })();
    </script>
    % }

    <script>
        // Save scroll position regularly
        setInterval(function() {
            localStorage.setItem('scrollY', window.scrollY);
        }, 200);

        // Auto-refresh price data every 5 minutes
        setTimeout(function() {
            location.reload();
        }, 300000);
    </script>

    <%= content_for 'scripts' %>
</body>
</html>
