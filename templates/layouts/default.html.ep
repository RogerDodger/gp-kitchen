<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - GP Kitchen</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/app-v6.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-left">
            <a href="/" class="nav-brand"><img src="/favicon.png" alt="" class="nav-logo">GP Kitchen</a>
            <a href="/cookbooks">Cookbooks</a>
            <div class="nav-search">
                <form action="/search" method="get">
                    <input type="text" name="q" id="search-input" placeholder="Search items..." value="<%= param('q') // '' %>" autocomplete="off">
                </form>
                <div class="search-dropdown" id="search-dropdown"></div>
            </div>
        </div>
        <div class="nav-right">
            % if (current_user && !is_guest) {
                % if (is_admin && is_dev_mode) {
                    <form method="post" action="/admin/update-prices" style="display:inline">
                        <input type="hidden" name="csrf_token" value="<%= csrf_token %>">
                        <button type="submit" class="btn btn-small">Update Prices</button>
                    </form>
                % }
                <a href="/user/password" class="nav-user"><%= current_user->{username} %></a>
                <a href="/logout">Logout</a>
            % } else {
                <a href="/login">Login</a>
            % }
        </div>
    </nav>

    % if (is_guest && current_user) {
        <div class="guest-banner">
            You're using a guest account.
            <a href="/register">Save your account</a> to keep your dashboard.
            <a href="/logout">Destroy it</a> if you want to start over.
        </div>
    % }

    <main class="container">
        <%= content %>
    </main>

    <footer class="footer">
        <p>
            % if (stash('stats') && stash('stats')->{total_items}) {
                <%= stash('stats')->{total_items} %> items |
                <%= stash('stats')->{items_with_high} // 0 %> with prices |
            % }
            Price data from <a href="https://prices.runescape.wiki" target="_blank">OSRS Wiki</a> |
            Last update: <%= time_ago(stash('stats') ? stash('stats')->{last_update} : undef) %> |
            <a href="/about">About</a>
        </p>
    </footer>

    % if (flash 'restore_scroll') {
    <script>
        (function() {
            var y = localStorage.getItem('scrollY');
            if (y) window.scrollTo(0, parseInt(y, 10));
        })();
    </script>
    % }

    <script>
        // Save scroll position regularly
        setInterval(function() {
            localStorage.setItem('scrollY', window.scrollY);
        }, 200);

        // Auto-refresh price data every 5 minutes
        setTimeout(function() {
            location.reload();
        }, 300000);

        // Live search
        (function() {
            const input = document.getElementById('search-input');
            const dropdown = document.getElementById('search-dropdown');
            if (!input || !dropdown) return;

            let debounceTimer;
            let selectedIndex = -1;
            let results = [];

            function formatGp(num) {
                if (!num) return '?';
                if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            }

            function renderDropdown() {
                if (results.length === 0) {
                    dropdown.innerHTML = '<div class="search-dropdown-empty">No items found</div>';
                    return;
                }

                let html = results.map((item, i) => `
                    <a href="/item/${item.id}" class="search-dropdown-item${i === selectedIndex ? ' selected' : ''}">
                        <img src="/images/items/${item.id}.png" alt="" onerror="this.style.display='none'">
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-price">${formatGp(item.high_price)} / ${formatGp(item.low_price)}</div>
                        </div>
                    </a>
                `).join('');

                if (results.length >= 10) {
                    html += `<a href="/search?q=${encodeURIComponent(input.value)}" class="search-dropdown-more">View all results</a>`;
                }

                dropdown.innerHTML = html;
            }

            function search(query) {
                if (query.length < 2) {
                    dropdown.classList.remove('active');
                    return;
                }

                fetch('/api/search?q=' + encodeURIComponent(query))
                    .then(r => r.json())
                    .then(data => {
                        results = data;
                        selectedIndex = -1;
                        renderDropdown();
                        dropdown.classList.add('active');
                    });
            }

            input.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => search(this.value), 150);
            });

            input.addEventListener('keydown', function(e) {
                if (!dropdown.classList.contains('active')) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, results.length - 1);
                    renderDropdown();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    renderDropdown();
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    window.location.href = '/item/' + results[selectedIndex].id;
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('active');
                }
            });

            input.addEventListener('focus', function() {
                if (this.value.length >= 2 && results.length > 0) {
                    dropdown.classList.add('active');
                }
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.nav-search')) {
                    dropdown.classList.remove('active');
                }
            });
        })();

        // Grid sorting
        (function() {
            function sortGrid(grid, sortKey, sortType, toggleDirection) {
                if (!grid) return;

                const header = grid.querySelector(`.sortable[data-sort="${sortKey}"]`);
                const isAsc = toggleDirection && header && header.classList.contains('sort-asc');

                // Get current settings from dashboard
                const dashboard = document.querySelector('.dashboard');
                const mode = dashboard ? dashboard.dataset.mode : 'patient';
                const vol = dashboard ? dashboard.dataset.vol : '4h';

                // Build data attribute name
                let dataAttr;
                if (sortType === 'text') {
                    dataAttr = `data-${sortKey}`;
                } else if (sortType === 'vol') {
                    dataAttr = `data-${sortKey}-${mode}-${vol}`;
                } else {
                    dataAttr = `data-${sortKey}-${mode}`;
                }

                // Get all recipe pairs
                const pairs = Array.from(grid.querySelectorAll('.recipe-pair'));
                if (pairs.length === 0) return;

                // Sort
                pairs.sort((a, b) => {
                    let aVal = a.getAttribute(dataAttr) || '';
                    let bVal = b.getAttribute(dataAttr) || '';

                    if (sortType === 'text') {
                        return isAsc
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);
                    } else {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                        return isAsc ? aVal - bVal : bVal - aVal;
                    }
                });

                // Update DOM
                pairs.forEach(pair => grid.appendChild(pair));

                // Update header classes
                grid.querySelectorAll('.sortable').forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                if (header) header.classList.add(isAsc ? 'sort-desc' : 'sort-asc');
            }

            // Header click handlers
            document.querySelectorAll('.grid-header .sortable').forEach(header => {
                header.addEventListener('click', function() {
                    const grid = this.closest('.recipes-grid');
                    sortGrid(grid, this.dataset.sort, this.dataset.sortType, true);
                });
            });

            const sortMap = {
                'inputs': 'cost',
                'outputs': 'revenue',
                'tax': 'tax',
                'profit': 'profit',
                'roi': 'roi'
            };

            // Summary label click handlers
            document.querySelectorAll('.pair-summary .summary-label').forEach(label => {
                label.style.cursor = 'pointer';
                label.classList.add('sortable');
                label.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const grid = this.closest('.recipes-grid');
                    const text = this.textContent.trim().toLowerCase();
                    const sortKey = sortMap[text];
                    if (sortKey) sortGrid(grid, sortKey, 'number', true);
                });
            });

            // Update summary labels when header sort changes
            function updateSummaryLabels(grid, sortKey, direction) {
                grid.querySelectorAll('.pair-summary .summary-label').forEach(label => {
                    label.classList.remove('sort-asc', 'sort-desc');
                    const text = label.textContent.trim().toLowerCase();
                    if (sortMap[text] === sortKey) {
                        label.classList.add(direction);
                    }
                });
            }

            // Patch sortGrid to also update summary labels
            const origSortGrid = sortGrid;
            sortGrid = function(grid, sortKey, sortType, toggleDirection) {
                const header = grid ? grid.querySelector(`.sortable[data-sort="${sortKey}"]`) : null;
                const isAsc = toggleDirection && header && header.classList.contains('sort-asc');
                origSortGrid(grid, sortKey, sortType, toggleDirection);
                if (grid) updateSummaryLabels(grid, sortKey, isAsc ? 'sort-desc' : 'sort-asc');
            };
        })();
    </script>

    <%= content_for 'scripts' %>
</body>
</html>
