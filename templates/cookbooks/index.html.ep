% layout 'default';
% title 'Cookbooks';

<div class="cookbooks-page dashboard" data-mode="patient" data-vol="4h">
    <h1>Cookbooks</h1>
    <p class="page-description">Curated recipe collections. Import them to your dashboard to jumpstart it.</p>

    % if (is_admin) {
        <div class="admin-actions" style="margin-bottom: 1rem;">
            <a href="/cookbooks/new" class="btn btn-primary">Create New Cookbook</a>
        </div>
    % }

    %= include 'partials/_price_vol_toggles'

    % my $cookbooks = stash('cookbooks') // [];
    % if (@$cookbooks) {
        % for my $cookbook (@$cookbooks) {
            <div class="cookbook-section">
                <div class="cookbook-section-header">
                    <h2><%= $cookbook->{name} %></h2>
                    % if (is_admin) {
                        <a href="/cookbooks/<%= $cookbook->{id} %>/recipes" class="btn btn-secondary btn-small">Edit</a>
                    % }
                    <span class="cookbook-recipe-count"><%= $cookbook->{total_recipes} %> recipes</span>
                </div>

                % if (@{$cookbook->{recipes}}) {
                    <div class="cookbook-recipes-wrapper collapsed">
                    <div class="cookbook-recipes-container">
                    <div class="recipes-grid">
                        <div class="grid-header">
                            <div class="hdr-input">Inputs (Buy)</div>
                            <div class="hdr-vol col-vol">Vol</div>
                            <div class="hdr-cost col-cost">Subtotal</div>
                            <div class="hdr-output">Outputs (Sell)</div>
                            <div class="hdr-vol col-vol">Vol</div>
                            <div class="hdr-revenue col-revenue">Subtotal</div>
                            <div class="hdr-tax col-tax">Tax</div>
                            <div class="hdr-profit col-profit">Profit</div>
                            <div class="hdr-roi col-roi">ROI</div>
                        </div>
                        % for my $recipe (@{$cookbook->{recipes}}) {
                            %= include 'partials/_recipe_pair', recipe => $recipe
                        % }
                    </div>
                    </div>
                    <button type="button" class="cookbook-expand-btn">Expand</button>
                    <div class="cookbook-footer">
                        <a href="/cookbooks/<%= $cookbook->{id} %>/import" class="btn btn-primary btn-small">Import</a>
                        <span class="cookbook-imports">
                            % if ($cookbook->{import_count} == 1) {
                                1 person has
                            % } else {
                                <%= $cookbook->{import_count} %> people have
                            % }
                            imported from this cookbook
                        </span>
                    </div>
                    </div>
                % } else {
                    <p class="empty-hint">No recipes in this cookbook yet.</p>
                % }
            </div>
        % }
    % } else {
        <div class="empty-state">
            <p>No cookbooks available yet.</p>
            % if (is_admin) {
                <a href="/cookbooks/new" class="btn btn-primary">Create the first cookbook</a>
            % }
        </div>
    % }
</div>

<script>
(function() {
    const dashboard = document.querySelector('.dashboard');
    document.querySelectorAll('.mode-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
            const mode = btn.dataset.mode;
            dashboard.dataset.mode = mode;
            document.querySelectorAll('.mode-toggle').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
        });
    });
    document.querySelectorAll('.vol-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
            const vol = btn.dataset.vol;
            dashboard.dataset.vol = vol;
            document.querySelectorAll('.vol-toggle').forEach(b => b.classList.toggle('active', b.dataset.vol === vol));
        });
    });
    document.querySelectorAll('.cookbook-expand-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const wrapper = btn.closest('.cookbook-recipes-wrapper');
            wrapper.classList.toggle('collapsed');
            btn.textContent = wrapper.classList.contains('collapsed') ? 'Expand' : 'Collapse';
        });
    });
})();
</script>
