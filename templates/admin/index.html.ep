% layout 'default';
% title 'Admin';

<div class="admin-dashboard">
    <h1>Admin Dashboard</h1>

    % if (flash 'success') {
        <div class="alert alert-success"><%= flash 'success' %></div>
    % }
    % if (flash 'error') {
        <div class="alert alert-error"><%= flash 'error' %></div>
    % }

    <div class="admin-section">
        <h2>Conversion Pairs</h2>

        <form method="post" action="/admin/conversions" class="new-conversion-form">
            <button type="submit" class="btn btn-primary">Add New Conversion</button>
        </form>

        % my $conversions = stash('conversions') // [];
        % my $current_order = join(',', map { $_->{id} } @$conversions);
        % if (@$conversions) {
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Sort</th>
                        <th>Inputs</th>
                        <th>Outputs</th>
                        <th>Live</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    % for my $conv (@$conversions) {
                        <tr id="conv-<%= $conv->{id} %>">
                            <td class="sort-controls">
                                <form method="post" action="/admin/conversions/reorder" style="display:inline">
                                    <input type="hidden" name="order" value="<%= $current_order %>">
                                    <input type="hidden" name="id" value="<%= $conv->{id} %>">
                                    <input type="hidden" name="dir" value="up">
                                    <button type="submit" class="btn btn-small" title="Move up">&#9650;</button>
                                </form>
                                <form method="post" action="/admin/conversions/reorder" style="display:inline">
                                    <input type="hidden" name="order" value="<%= $current_order %>">
                                    <input type="hidden" name="id" value="<%= $conv->{id} %>">
                                    <input type="hidden" name="dir" value="down">
                                    <button type="submit" class="btn btn-small" title="Move down">&#9660;</button>
                                </form>
                            </td>
                            <td>
                                % if (@{$conv->{inputs}}) {
                                    % for my $input (@{$conv->{inputs}}) {
                                        <div><%= $input->{quantity} %>x <%= $input->{name} %></div>
                                    % }
                                % } else {
                                    <em>None</em>
                                % }
                            </td>
                            <td>
                                % if (@{$conv->{outputs}}) {
                                    % for my $output (@{$conv->{outputs}}) {
                                        <div><%= $output->{quantity} %>x <%= $output->{name} %></div>
                                    % }
                                % } else {
                                    <em>None</em>
                                % }
                            </td>
                            <td>
                                <form method="post" action="/admin/conversions/<%= $conv->{id} %>/toggle-live" style="display:inline">
                                    <button type="submit" class="btn btn-small <%= $conv->{live} ? 'btn-live' : '' %>">
                                        <%= $conv->{live} ? 'Live' : '-' %>
                                    </button>
                                </form>
                            </td>
                            <td>
                                <form method="post" action="/admin/conversions/<%= $conv->{id} %>/toggle" style="display:inline">
                                    <button type="submit" class="btn btn-small <%= $conv->{active} ? 'btn-active' : '' %>">
                                        <%= $conv->{active} ? 'Active' : 'Inactive' %>
                                    </button>
                                </form>
                            </td>
                            <td>
                                <a href="/admin/conversions/<%= $conv->{id} %>/edit" class="btn btn-small">Edit</a>
                                <form method="post" action="/admin/conversions/<%= $conv->{id} %>/delete" style="display:inline" onsubmit="return confirm('Delete?')">
                                    <button type="submit" class="btn btn-small btn-danger">Delete</button>
                                </form>
                            </td>
                        </tr>
                    % }
                </tbody>
            </table>
        % } else {
            <p class="empty-state">No conversions yet. Create one above!</p>
        % }
    </div>
</div>
